name: Build WebUI-Server
on:
  push:
env:
  APP_NAME: "WebCFace WebUI Server.app"
  TAG: "v1.5.2" # todo: あとでかえる
jobs:
  build:
    runs-on: macos-13
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: 18
    - run: git clone https://github.com/na-trium-144/webcface-webui.git
    - name: Patch source code
      working-directory: webcface-webui/electron/main
      run: |
        sed '2i\
        process.env.PATH = app.getPath("exe") + "/../homebrew/bin:" + process.env.PATH;
        ' index.ts > new_index.ts
        mv new_index.ts index.ts
    - run: npm install --prefer-offline --no-audit --maxsockets 1
      working-directory: webcface-webui
    - run: npm run ebuild
      working-directory: webcface-webui
    - run: mv webcface-webui/release/mac/*.app "$APP_NAME"
    - name: Setup Homebrew and install webcface
      working-directory: ${{env.APP_NAME}}/Contents
      run: |
        git clone https://github.com/Homebrew/brew homebrew
        eval "$(./homebrew/bin/brew shellenv)"
        ./homebrew/bin/brew update --force --quiet
        chmod -R go-w ./homebrew/share/zsh
        ./homebrew/bin/brew tap na-trium-144/webcface
        ./homebrew/bin/brew install webcface webcface-tools webcface-webui
    - run: zip -r "${APP_NAME}.zip" "$APP_NAME"
    - name: Create Tag
      run: |
        git tag v$TAG
    - uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        tags: true
    - name: Release
      uses: docker://antonyurchenko/git-release:v5
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        ALLOW_EMPTY_CHANGELOG: true
      with:
        args: "${APP_NAME}.zip"


